// פונקציה מרכזית לרישום ושמירה
async function handleSubscription(userId) {
    const statusEl = document.getElementById('status');
    
    // 1. רישום מול OneSignal (לוודא שיופיע בדאשבורד)
    OneSignal.push(async function() {
        await OneSignal.registerForPushNotifications();
        const playerId = await OneSignal.getUserId();

        if (playerId) {
            // 2. שמירה בבייס44 בשיטת Upsert (מניעת כפילויות)
            await syncWithBase44(userId, playerId);
        } else {
            statusEl.innerText = "❌ שגיאה: לא התקבל מזהה מכשיר מוואן סינגל";
        }
    });
}

async function syncWithBase44(userId, playerId) {
    const tableId = 'PushSubscription';
    const apiKey = 'YOUR_BASE44_API_KEY';

    // בדיקה אם המשתמש כבר קיים
    const checkResp = await fetch(`https://api.base44.app/v1/entities/${tableId}/list`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ filter: { user_id: { _eq: userId } } })
    });
    const existing = await checkResp.json();

    if (existing.length > 0) {
        // עדכון שורה קיימת
        await fetch(`https://api.base44.app/v1/entities/${tableId}/${existing[0].id}`, {
            method: 'PATCH',
            headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ player_id: playerId })
        });
    } else {
        // יצירת שורה חדשה
        await fetch(`https://api.base44.app/v1/entities/${tableId}`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId, player_id: playerId })
        });
    }
    document.getElementById('status').innerText = "✅ המכשיר קושר בהצלחה! אפשר לסגור.";
}
