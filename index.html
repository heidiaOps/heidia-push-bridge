<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>חיבור התראות - Heidia</title>
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignal.SDK.js" defer></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; background-color: #f0f2f5; }
        .card { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 90%; }
        button { background: #007bff; color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 8px; cursor: pointer; width: 100%; margin-top: 20px; }
        button:disabled { background: #ccc; }
        .log-box { margin-top: 20px; font-size: 12px; color: #555; text-align: left; background: #f9f9f9; padding: 10px; border-radius: 5px; border: 1px solid #eee; height: 100px; overflow-y: auto; direction: ltr; }
    </style>
</head>
<body>
    <div class="card">
        <h2 id="status">חיבור מכשיר</h2>
        <p>לחץ לאישור וקבלת התראות</p>
        <button id="reg-btn" onclick="startRegistration()">הפעל התראות</button>
        <div class="log-box" id="debug-log">Log started...</div>
    </div>

    <script>
        // --- הגדרות ---
        const CONFIG = {
            APP_ID: "YOUR_ONESIGNAL_APP_ID", // שים כאן את ה-ID מוואן סינגל
            API_KEY: "YOUR_BASE44_API_KEY"   // שים כאן את המפתח מבייס
        };

        function log(msg) {
            const el = document.getElementById('debug-log');
            el.innerHTML += `<div>> ${msg}</div>`;
            el.scrollTop = el.scrollHeight;
            console.log(msg);
        }

        window.OneSignal = window.OneSignal || [];
        OneSignal.push(function() {
            log("Init OneSignal v16...");
            OneSignal.init({
                appId: CONFIG.APP_ID,
                allowLocalhostAsSecureOrigin: true,
            });
        });

        async function startRegistration() {
            const btn = document.getElementById('reg-btn');
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('uid');

            if (!userId) return log("Error: No User ID in URL");

            btn.disabled = true;
            btn.innerText = "מתחבר...";
            
            try {
                log("Requesting permission...");
                // שלב 1: בקשת הרשאה (כאן זה נתקע אם חסום)
                await OneSignal.Slidedown.promptPush(); 
                
                log("Permission requested. Checking state...");
                
                // שלב 2: המתנה לרישום וקבלת ID
                OneSignal.User.PushSubscription.addEventListener("change", async (e) => {
                    if (e.current.id) {
                        log("Got Player ID: " + e.current.id);
                        await syncBase44(userId, e.current.id);
                    }
                });

                // ניסיון משיכה ישיר למקרה שכבר רשום
                const currentId = OneSignal.User.PushSubscription.id;
                if (currentId) {
                    log("User already registered: " + currentId);
                    await syncBase44(userId, currentId);
                } else {
                    log("Waiting for user to allow...");
                }

            } catch (e) {
                log("Error: " + e.message);
                btn.disabled = false;
                btn.innerText = "נסה שוב";
            }
        }

        async function syncBase44(uid, pid) {
            log("Syncing with Base44...");
            const tableId = 'PushSubscription';
            
            // בדיקת כפילויות
            const check = await fetch(`https://api.base44.app/v1/entities/${tableId}/list`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${CONFIG.API_KEY}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ filter: { user_id: { _eq: uid } } })
            });
            const existing = await check.json();
            
            let url = `https://api.base44.app/v1/entities/${tableId}`;
            let method = 'POST';

            if (existing?.length > 0) {
                url += `/${existing[0].id}`;
                method = 'PATCH';
                log("Updating existing user...");
            } else {
                log("Creating new user...");
            }

            const res = await fetch(url, {
                method: method,
                headers: { 'Authorization': `Bearer ${CONFIG.API_KEY}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: uid, player_id: pid })
            });

            if (res.ok) {
                document.getElementById('status').innerText = "✅ הצלחה!";
                log("Done! You can close this.");
                document.getElementById('reg-btn').style.display = 'none';
            } else {
                log("Base44 Error: " + res.status);
            }
        }
    </script>
</body>
</html>
