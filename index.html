<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>חיבור התראות - Heidia</title>
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignal.SDK.js" defer></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; background-color: #f8fafc; }
        .card { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 90%; }
        h1 { margin-top: 0; color: #334155; }
        p { color: #64748b; margin-bottom: 30px; }
        button { background: #3b82f6; color: white; border: none; padding: 16px 32px; font-size: 18px; border-radius: 12px; cursor: pointer; width: 100%; font-weight: bold; transition: all 0.2s; }
        button:hover { background: #2563eb; transform: translateY(-2px); }
        button:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; }
        .log { margin-top: 20px; font-size: 13px; color: #94a3b8; background: #f1f5f9; padding: 10px; border-radius: 8px; text-align: left; direction: ltr; min-height: 40px; }
        .success { color: #10b981; font-weight: bold; }
    </style>
</head>
<body>

    <div class="card">
        <h1>חיבור מכשיר</h1>
        <p>לחץ כדי לאפשר קבלת עדכונים מהמערכת</p>
        <button id="btn" onclick="register()">הפעל התראות</button>
        <div id="log" class="log">ממתין לפעולה...</div>
    </div>

    <script>
        // --- ההגדרות שלך כבר בפנים ---
        const CONFIG = {
            ONESIGNAL_APP_ID: "c86fd007-74ba-4668-b186-52156233ead7", 
            BASE44_API_KEY: "083d08d80a3f45318da8dddd408fc6a8"      
        };

        const logEl = document.getElementById('log');
        const btn = document.getElementById('btn');

        function log(msg) {
            logEl.innerText = msg;
            console.log(msg);
        }

        // אתחול המערכת
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(async function(OneSignal) {
            await OneSignal.init({
                appId: CONFIG.ONESIGNAL_APP_ID,
            });
            log("המערכת מוכנה. לחץ על הכפתור.");
        });

        async function register() {
            btn.disabled = true;
            btn.innerText = "מתחבר...";
            
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('uid');

            if (!userId) {
                log("שגיאה: חסר מזהה משתמש בקישור");
                return;
            }

            try {
                log("מבקש הרשאה...");
                await OneSignal.Slidedown.promptPush();

                log("בודק סטטוס רישום...");
                let playerId = OneSignal.User.PushSubscription.id;
                
                if (playerId) {
                    await syncBase44(userId, playerId);
                } else {
                    log("ממתין לאישור בדפדפן...");
                    OneSignal.User.PushSubscription.addEventListener("change", async (e) => {
                        if (e.current.id) {
                            await syncBase44(userId, e.current.id);
                        }
                    });
                }
            } catch (e) {
                log("שגיאה: " + e.message);
                btn.disabled = false;
                btn.innerText = "נסה שוב";
            }
        }

        async function syncBase44(userId, playerId) {
            log("נרשם בהצלחה! שומר בבייס...");
            
            const tableId = 'PushSubscription';
            
            try {
                // 1. בדיקה אם המשתמש כבר קיים בטבלה
                const check = await fetch(`https://api.base44.app/v1/entities/${tableId}/list`, {
                    method: 'POST',
                    headers: { 'api_key': CONFIG.BASE44_API_KEY, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filter: { user_id: { _eq: userId } } })
                });
                const existing = await check.json();

                let url = `https://api.base44.app/v1/entities/${tableId}`;
                let method = 'POST';

                if (existing && existing.length > 0) {
                    url = `${url}/${existing[0].id}`;
                    method = 'PATCH'; // שינינו ל-PUT/PATCH לפי מה שבייס תומך
                }

                // 2. שמירה או עדכון
                const res = await fetch(url, {
                    method: method,
                    headers: { 'api_key': CONFIG.BASE44_API_KEY, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, player_id: playerId })
                });

                if (res.ok) {
                    log("✅ המכשיר חובר בהצלחה! אפשר לסגור.");
                    btn.style.display = 'none';
                    document.querySelector('h1').className = 'success';
                } else {
                    log("שגיאה בשמירה: " + res.status);
                }
            } catch (err) {
                log("שגיאה בתקשורת: " + err.message);
            }
        }
    </script>
</body>
</html>
