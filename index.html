const userId = new URLSearchParams(window.location.search).get('uid');

window.OneSignal = window.OneSignal || [];
OneSignal.push(function() {
    OneSignal.init({
        appId: "YOUR_APP_ID", // וודא שזה ה-ID הנכון!
        safari_web_id: "YOUR_SAFARI_ID", // אם יש לך
        notifyButton: { enable: false },
    });

    // ברגע שהדף עולה - ננסה להוציא את ה-ID
    OneSignal.on('subscriptionChange', function (isSubscribed) {
        if (isSubscribed) {
            registerAndSync();
        }
    });
});

async function registerAndSync() {
    const playerId = await OneSignal.getUserId();
    if (playerId && userId) {
        alert("נמצא Player ID: " + playerId); // בדיקה ויזואלית
        await syncWithBase44(userId, playerId);
    }
}

async function syncWithBase44(uid, pid) {
    const apiKey = 'YOUR_BASE44_API_KEY';
    // לוגיקת ה-Upsert (מניעת כפילויות)
    const check = await fetch(`https://api.base44.app/v1/entities/PushSubscription/list`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ filter: { user_id: { _eq: uid } } })
    });
    const existing = await check.json();

    const url = existing.length > 0 
        ? `https://api.base44.app/v1/entities/PushSubscription/${existing[0].id}`
        : `https://api.base44.app/v1/entities/PushSubscription`;
    
    await fetch(url, {
        method: existing.length > 0 ? 'PATCH' : 'POST',
        headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_id: uid, player_id: pid })
    });
    
    document.getElementById('status').innerText = "✅ הרישום הושלם בהצלחה!";
}

// פונקציית הכפתור האדום
function askPermission() {
    OneSignal.showNativePrompt();
}
