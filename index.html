<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>חיבור התראות - Heidia</title>
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignal.SDK.js" defer></script>
</head>
<body style="font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; background-color: #f4f7f6;">

    <div style="background: white; padding: 40px; border-radius: 20px; shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; border: 1px solid #ddd;">
        <h1 id="status" style="color: #333; margin-bottom: 20px;">חיבור מכשיר למערכת Heidia</h1>
        <p style="color: #666; margin-bottom: 30px;">לחץ על הכפתור למטה כדי לאשר קבלת התראות במכשיר זה.</p>
        
        <button id="reg-btn" onclick="handleSubscription()" style="padding: 20px 40px; font-size: 20px; background: #ef4444; color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; transition: transform 0.2s;">
            אשר והפעל התראות
        </button>
    </div>

    <script>
        // שליפת ה-ID מהכתובת (URL)
        const urlParams = new URLSearchParams(window.location.search);
        const userIdFromUrl = urlParams.get('uid');

        window.OneSignal = window.OneSignal || [];
        OneSignal.push(function() {
            OneSignal.init({
                appId: "YOUR_ONESIGNAL_APP_ID", // שים כאן את ה-ID מוואן סינגל
            });
        });

        async function handleSubscription() {
            const statusEl = document.getElementById('status');
            const btnEl = document.getElementById('reg-btn');

            if (!userIdFromUrl) {
                statusEl.innerText = "❌ שגיאה: לא זוהה מזהה משתמש";
                return;
            }

            statusEl.innerText = "מבצע רישום... המתן";
            btnEl.disabled = true;
            btnEl.style.opacity = "0.5";

            OneSignal.push(async function() {
                try {
                    await OneSignal.registerForPushNotifications();
                    const deviceState = await OneSignal.getDeviceState();
                    const playerId = deviceState.userId;

                    if (playerId) {
                        await syncWithBase44(userIdFromUrl, playerId);
                    } else {
                        statusEl.innerText = "❌ שגיאה: לא התקבל מזהה מוואן סינגל";
                        btnEl.disabled = false;
                        btnEl.style.opacity = "1";
                    }
                } catch (e) {
                    statusEl.innerText = "❌ שגיאה בתהליך הרישום";
                    console.error(e);
                }
            });
        }

        async function syncWithBase44(userId, playerId) {
            const tableId = 'PushSubscription';
            const apiKey = 'YOUR_BASE44_API_KEY'; // שים כאן את המפתח שלך

            // בדיקת כפילויות (Upsert)
            const checkResp = await fetch(`https://api.base44.app/v1/entities/${tableId}/list`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ filter: { user_id: { _eq: userId } } })
            });
            const existing = await checkResp.json();

            let url = `https://api.base44.app/v1/entities/${tableId}`;
            let method = 'POST';

            if (existing && existing.length > 0) {
                url = `${url}/${existing[0].id}`;
                method = 'PATCH';
            }

            const response = await fetch(url, {
                method: method,
                headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId, player_id: playerId })
            });

            if (response.ok) {
                document.getElementById('status').innerText = "✅ המכשיר קושר בהצלחה!";
                document.getElementById('reg-btn').style.display = 'none';
            } else {
                document.getElementById('status').innerText = "❌ שגיאה בשמירת הנתונים בבייס";
            }
        }
    </script>
</body>
</html>
