<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>חיבור התראות - Heidia</title>
    
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignal.SDK.js" defer onerror="handleScriptError()"></script>
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; background-color: #f1f5f9; }
        .card { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); text-align: center; max-width: 400px; width: 90%; }
        h1 { margin-top: 0; color: #1e293b; font-size: 24px; }
        p { color: #64748b; margin-bottom: 30px; line-height: 1.5; }
        button { background: #3b82f6; color: white; border: none; padding: 16px 32px; font-size: 18px; border-radius: 12px; cursor: pointer; width: 100%; font-weight: 600; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5); }
        button:hover { background: #2563eb; transform: translateY(-2px); box-shadow: 0 6px 8px -1px rgba(59, 130, 246, 0.6); }
        button:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; box-shadow: none; color: #94a3b8; }
        .log { margin-top: 20px; font-size: 13px; color: #64748b; background: #f8fafc; padding: 12px; border-radius: 8px; text-align: left; direction: ltr; border: 1px solid #e2e8f0; min-height: 20px; font-family: monospace; }
        .success { color: #10b981; } .error { color: #ef4444; }
    </style>
</head>
<body>

    <div class="card">
        <h1 id="title">חיבור מכשיר</h1>
        <p>לחץ על הכפתור למטה כדי לאשר קבלת התראות ועדכונים מהמערכת.</p>
        <button id="btn" onclick="register()">הפעל התראות</button>
        <div id="log" class="log">טוען מערכת...</div>
    </div>

    <script>
        // --- מפתחות המערכת (כבר מעודכנים) ---
        const CONFIG = {
            ONESIGNAL_APP_ID: "c86fd007-74ba-4668-b186-52156233ead7", 
            BASE44_API_KEY: "083d08d80a3f45318da8dddd408fc6a8"      
        };

        const logEl = document.getElementById('log');
        const btn = document.getElementById('btn');
        let isOneSignalLoaded = false;

        function log(msg) {
            logEl.innerText = msg;
            console.log(msg);
        }

        function handleScriptError() {
            log("❌ שגיאה: חוסם פרסומות מונע את הטעינה. נסה לבטל AdBlock.");
            btn.innerText = "שגיאת חוסם פרסומות";
            btn.style.backgroundColor = "#ef4444";
        }

        // אתחול OneSignal
        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(async function(OneSignal) {
            isOneSignalLoaded = true;
            await OneSignal.init({
                appId: CONFIG.ONESIGNAL_APP_ID,
            });
            log("המערכת מוכנה. לחץ על הכפתור.");
        });

        // "רשת ביטחון" למקרה שהספרייה נתקעת
        setTimeout(() => {
            if (!isOneSignalLoaded && logEl.innerText === "טוען מערכת...") {
                log("⚠️ הטעינה איטית. בדוק את החיבור שלך.");
            }
        }, 5000);

        async function register() {
            // בדיקת הגנות לפני הכל
            if (typeof OneSignalDeferred === 'undefined') {
                log("שגיאה קריטית: הספרייה לא נטענה.");
                return;
            }

            btn.disabled = true;
            btn.innerText = "מתחבר...";
            
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('uid');

            if (!userId) {
                log("שגיאה: הקישור לא תקין (חסר מזהה משתמש)");
                return;
            }

            // שימוש בטוח בתוך המעטפת של OneSignal
            window.OneSignalDeferred.push(async function(OneSignal) {
                try {
                    log("מבקש אישור...");
                    
                    // שיטה ישירה להקפצת החלונית
                    await OneSignal.User.PushSubscription.optIn();

                    log("בודק סטטוס...");
                    // המתנה קצרה לוודא שהסטטוס התעדכן
                    await new Promise(r => setTimeout(r, 1000));

                    let playerId = OneSignal.User.PushSubscription.id;
                    
                    if (playerId) {
                        await syncBase44(userId, playerId);
                    } else {
                        log("ממתין לאישור בדפדפן...");
                        // מאזין לשינוי בהרשמה
                        OneSignal.User.PushSubscription.addEventListener("change", async (e) => {
                            if (e.current.id) {
                                await syncBase44(userId, e.current.id);
                            }
                        });
                    }
                } catch (e) {
                    console.error(e);
                    log("שגיאה: " + (e.message || "לא ניתן היה להשלים את הרישום"));
                    btn.disabled = false;
                    btn.innerText = "נסה שוב";
                }
            });
        }

        async function syncBase44(userId, playerId) {
            log("נרשם בהצלחה! מעדכן את המערכת...");
            
            const tableId = 'PushSubscription';
            
            try {
                // 1. בדיקת כפילויות
                const check = await fetch(`https://api.base44.app/v1/entities/${tableId}/list`, {
                    method: 'POST',
                    headers: { 'api_key': CONFIG.BASE44_API_KEY, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filter: { user_id: { _eq: userId } } })
                });
                
                if (!check.ok) throw new Error("Base44 List Failed");
                const existing = await check.json();

                let url = `https://api.base44.app/v1/entities/${tableId}`;
                let method = 'POST'; // ברירת מחדל: יצירה חדשה

                if (existing && existing.length > 0) {
                    url = `${url}/${existing[0].id}`; // אם קיים -> נעדכן אותו
                    method = 'PATCH';
                }

                // 2. שמירה סופית
                const res = await fetch(url, {
                    method: method,
                    headers: { 'api_key': CONFIG.BASE44_API_KEY, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, player_id: playerId })
                });

                if (res.ok) {
                    log("✅ המכשיר חובר בהצלחה! אפשר לסגור.");
                    document.getElementById('title').innerText = "חובר בהצלחה!";
                    document.getElementById('title').className = "success";
                    btn.style.display = 'none';
                } else {
                    log("שגיאה בשמירה: " + res.status);
                }
            } catch (err) {
                log("שגיאת תקשורת: " + err.message);
            }
        }
    </script>
</body>
</html>
