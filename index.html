<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>חיבור התראות - Heidia</title>
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignal.SDK.js" defer></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; background-color: #f8fafc; }
        .card { background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 90%; }
        button { background: #3b82f6; color: white; border: none; padding: 16px 32px; font-size: 18px; border-radius: 12px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 20px; }
        .log { margin-top: 20px; font-size: 13px; color: #94a3b8; }
    </style>
</head>
<body>

    <div class="card">
        <h1>חיבור מכשיר</h1>
        <p>לחץ לאישור קבלת התראות</p>
        <button id="btn" onclick="register()">הפעל התראות</button>
        <div id="log" class="log"></div>
    </div>

    <script>
        // המפתחות הנכונים שלך
        const CONFIG = {
            ONESIGNAL_APP_ID: "c86fd007-74ba-4668-b186-52156233ead7", 
            BASE44_API_KEY: "083d08d80a3f45318da8dddd408fc6a8"      
        };

        const logEl = document.getElementById('log');
        const btn = document.getElementById('btn');

        function log(msg) {
            logEl.innerText = msg;
        }

        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(function(OneSignal) {
            OneSignal.init({
                appId: CONFIG.ONESIGNAL_APP_ID,
            });
        });

        async function register() {
            btn.disabled = true;
            btn.innerText = "מתחבר...";
            
            const userId = new URLSearchParams(window.location.search).get('uid');

            if (!userId) {
                log("שגיאה: חסר מזהה משתמש בקישור");
                return;
            }

            OneSignalDeferred.push(async function(OneSignal) {
                try {
                    // בקשת אישור פשוטה
                    await OneSignal.User.PushSubscription.optIn();

                    // המתנה קצרה שה-ID יתעדכן
                    setTimeout(async () => {
                        const playerId = OneSignal.User.PushSubscription.id;
                        
                        if (playerId) {
                            await syncBase44(userId, playerId);
                        } else {
                            // אם עדיין אין ID, ננסה שוב בעוד רגע (זה מה שעבד קודם)
                            OneSignal.User.PushSubscription.addEventListener("change", async (e) => {
                                if (e.current.id) {
                                    await syncBase44(userId, e.current.id);
                                }
                            });
                            log("ממתין לאישור בדפדפן...");
                        }
                    }, 1000);
                } catch (e) {
                    log("שגיאה: " + e.message);
                    btn.disabled = false;
                }
            });
        }

        async function syncBase44(userId, playerId) {
            log("שומר נתונים...");
            
            const tableId = 'PushSubscription';
            
            try {
                // בדיקה אם קיים
                const check = await fetch(`https://api.base44.app/v1/entities/${tableId}/list`, {
                    method: 'POST',
                    headers: { 'api_key': CONFIG.BASE44_API_KEY, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filter: { user_id: { _eq: userId } } })
                });
                const existing = await check.json();

                let url = `https://api.base44.app/v1/entities/${tableId}`;
                let method = 'POST';

                if (existing && existing.length > 0) {
                    url = `${url}/${existing[0].id}`;
                    method = 'PATCH'; 
                }

                const res = await fetch(url, {
                    method: method,
                    headers: { 'api_key': CONFIG.BASE44_API_KEY, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId, player_id: playerId })
                });

                if (res.ok) {
                    log("✅ המכשיר חובר בהצלחה!");
                    btn.style.display = 'none';
                } else {
                    log("שגיאה בשמירה בבייס");
                }
            } catch (err) {
                log("שגיאה בתקשורת: " + err.message);
            }
        }
    </script>
</body>
</html>
