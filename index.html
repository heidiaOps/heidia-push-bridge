// פונקציה מרכזית שמופעלת בלחיצה על הכפתור האדום
async function handleSubscription(userId) {
    const statusEl = document.getElementById('status');
    statusEl.innerText = "מבצע רישום... אנא המתן";

    OneSignal.push(async function() {
        // 1. בקשת הרשאה והרשמה
        await OneSignal.registerForPushNotifications();
        
        // 2. בדיקה אם המשתמש נרשם בהצלחה
        const isSubscribed = await OneSignal.isPushNotificationsEnabled();
        
        if (isSubscribed) {
            // קבלת ה-ID החדש (בגרסה החדשה זה הדרך הבטוחה)
            const deviceState = await OneSignal.getDeviceState();
            const playerId = deviceState.userId;

            if (playerId) {
                console.log("OneSignal Player ID:", playerId);
                await syncWithBase44(userId, playerId);
            } else {
                statusEl.innerText = "❌ שגיאה: לא הצלחנו לקבל מזהה מכשיר";
            }
        } else {
            statusEl.innerText = "❌ הרישום נדחה. וודא שאישרת התראות בדפדפן.";
        }
    });
}

async function syncWithBase44(userId, playerId) {
    const tableId = 'PushSubscription';
    const apiKey = 'YOUR_BASE44_API_KEY';

    try {
        // בדיקת כפילויות (Upsert)
        const checkResp = await fetch(`https://api.base44.app/v1/entities/${tableId}/list`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({ filter: { user_id: { _eq: userId } } })
        });
        const existing = await checkResp.json();

        let response;
        if (existing.length > 0) {
            // עדכון שורה קיימת (מונע כפילויות בטבלה)
            response = await fetch(`https://api.base44.app/v1/entities/${tableId}/${existing[0].id}`, {
                method: 'PATCH',
                headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ player_id: playerId })
            });
        } else {
            // יצירת שורה חדשה
            response = await fetch(`https://api.base44.app/v1/entities/${tableId}`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId, player_id: playerId })
            });
        }

        if (response.ok) {
            document.getElementById('status').innerText = "✅ המכשיר קושר בהצלחה! אפשר לסגור.";
        }
    } catch (err) {
        document.getElementById('status').innerText = "❌ שגיאה בסנכרון מול בסיס הנתונים";
    }
}
