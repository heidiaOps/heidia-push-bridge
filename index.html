<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>חיבור התראות</title>
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignal.SDK.js" defer></script>
</head>
<body style="text-align: center; padding-top: 50px; font-family: sans-serif;">

    <h1>חיבור מכשיר</h1>
    <button id="btn" onclick="register()" style="padding: 20px 40px; font-size: 20px; background: blue; color: white; border: none; border-radius: 10px;">
        הפעל התראות
    </button>
    <div id="status" style="margin-top: 20px;"></div>

    <script>
        // המפתחות שלך
        const APP_ID = "c86fd007-74ba-4668-b186-52156233ead7";
        const API_KEY = "083d08d80a3f45318da8dddd408fc6a8";

        window.OneSignalDeferred = window.OneSignalDeferred || [];
        OneSignalDeferred.push(function(OneSignal) {
            OneSignal.init({
                appId: APP_ID,
            });
        });

        async function register() {
            document.getElementById('status').innerText = "מתחבר...";
            
            // שליפת המזהה מהכתובת
            const userId = new URLSearchParams(window.location.search).get('uid');
            if (!userId) {
                alert("אין מזהה משתמש");
                return;
            }

            OneSignalDeferred.push(async function(OneSignal) {
                // 1. בקשת אישור
                await OneSignal.User.PushSubscription.optIn();

                // 2. המתנה קצרה וקבלת ה-ID
                setTimeout(async () => {
                    const playerId = OneSignal.User.PushSubscription.id;
                    
                    if (playerId) {
                        // 3. שמירה בבייס (החלק שעבד לך)
                        await saveToBase(userId, playerId);
                    } else {
                        document.getElementById('status').innerText = "לא התקבל מזהה. נסה ללחוץ שוב.";
                    }
                }, 1000);
            });
        }

        async function saveToBase(uid, pid) {
            const url = "https://api.base44.app/v1/entities/PushSubscription";
            
            // פשוט שולח POST (יצירה). אם נכשל כי קיים - לא נורא.
            try {
                await fetch(url, {
                    method: 'POST',
                    headers: { 'api_key': API_KEY, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: uid, player_id: pid })
                });
                
                // הצלחה
                document.getElementById('status').innerText = "✅ נרשם בהצלחה!";
                document.getElementById('btn').style.display = 'none';

            } catch (e) {
                // גם אם נכשל, ננסה לעדכן (PATCH)
                try {
                     const check = await fetch(url + "/list", {
                        method: 'POST',
                        headers: { 'api_key': API_KEY, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filter: { user_id: { _eq: uid } } })
                    });
                    const existing = await check.json();
                    if(existing.length > 0) {
                        await fetch(url + "/" + existing[0].id, {
                            method: 'PATCH',
                            headers: { 'api_key': API_KEY, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ player_id: pid })
                        });
                        document.getElementById('status').innerText = "✅ נרשם בהצלחה!";
                        document.getElementById('btn').style.display = 'none';
                    }
                } catch(err) {
                    alert("שגיאה בבייס: " + err.message);
                }
            }
        }
    </script>
</body>
</html>
